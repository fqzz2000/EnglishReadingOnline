<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>托福模拟考试</title>
    <link rel="stylesheet" type="text/css" href="reading1.css" />
    <script src="https://cdn.staticfile.org/jquery/1.10.2/jquery.min.js"></script>
    <script src="question_data.js"></script>
</head>
<script>
    var received, params;
    received = window.location.search.substring(1).split('&');
    params = {};
    for (let str of received) {
        str_list = str.split('=');
        params[str_list[0]] = str_list[1];
    }
    var questions = [];
    var title = [];
    var passage = [];
    var question_answer = [];
    used_data = data[params['tpo']];
    if (params.full != 'false') {


        for (let i in used_data) {
            title.push(used_data[i].title);
            questions.push.apply(questions, used_data[i].questions);
            passage.push(used_data[i].passage);
            question_answer.push.apply(question_answer, used_data[i].answer);
        }
    } else {
        used_data = used_data[Number(params.passage)]
        title.push(used_data.title);
        questions = used_data.questions;
        passage.push(used_data.passage);
        question_answer = used_data.answer;

    }


    //     var title = [data['56'][0]['title'], data['56'][1]['title']];
    // var questions = data['56'][0]['questions'];
    // questions.push.apply(questions, data['56'][1]['questions']);
    // var passage = [data['56'][0]['passage'], data['56'][1]['passage']];
    // var question_answer = data['56'][0]['answer'];
    // question_answer.push.apply(question_answer, data['56'][1]['answer']);    
    // var title = [data['56'][0]['title']];
    // var questions = data['56'][0]['questions'];

    // var passage = [data['56'][0]['passage']];
    // var question_answer = data['56'][0]['answer'];
</script>

<body>
    <nav>

        <span id='navcontent'>Official 56 Reading</span>


        <a href="javascript:void(0)" id="next_question">下一题</a>
        <a href="javascript:void(0)" id="previous_question">上一题</a>
        <a href="javascript:void(0)" id="toreport" style="visibility: hidden;">返回评分界面</a>
        <a href="javascript:void(0)" id="backtoindex">返回首页</a>

    </nav>
    <div id="main">
        <div id="majority">
            <div id="left">
                <p>1. The word "updated " in the passage is closest in meaning to </p>
                <ul id="options">
                    <li><input type="radio" name="option" value=0>A. <span id="A">required</span></li>
                    <li><input type="radio" name="option" value=1>B. <span id="B">popular</span></li>
                    <li><input type="radio" name="option" value=2>C. <span id="C">newer</span></li>
                    <li><input type="radio" name="option" value=3>D. <span id="D">various</span></li>
                </ul>
            </div>
            <div id="right">
                <div id='passage'>
                    <span id="title"></span>
                    <div id='content'>

                    </div>
                </div>
            </div>
        </div>
        <div id="structure">
            <div id="directions">
                <table>
                    <tr>
                        <td>
                            <div>Directions: An introductory sentence for a brief summary of the passage is provided below. Complete the summary by selecting the THREE answer choices that express the most important ideas in the passage. Some sentences do not
                                belong in the summary because they express ideas that are not presented in the passage or are minor ideas in the passage. This question is worth 2 points.</div>
                        </td>
                    </tr>
                    <tr>
                        <td>
                            <div><strong>Click</strong> your answer choices to the spaces where they belong. To remove an answer choice, click on it.To review the passage, click VIEW TEXT.</div>
                        </td>
                    </tr>
                </table>
            </div>
            <div id='question-field'>
                <ul>
                    <li>
                        <div id='structure-leading'><strong>The chemical elements that make up cells are likely to be available on just about any planet.</strong></div>
                    </li>
                    <li>
                        <div index=0></div>
                    </li>
                    <li>
                        <div index=1></div>
                    </li>
                    <li>
                        <div index=2></div>
                    </li>
                </ul>
            </div>
            <div id='answer-choices'>
                <h4>Answer Choices</h4>
                <table>
                    <tody>
                        <tr>
                            <td>
                                <div value=0></div>
                            </td>
                            <td>
                                <div value=1></div>
                            </td>
                        </tr>
                        <tr>
                            <td>
                                <div value=2></div>
                            </td>
                            <td>
                                <div value=3></div>
                            </td>
                        </tr>
                        <tr>
                            <td>
                                <div value=4></div>
                            </td>
                            <td>
                                <div value=5></div>
                            </td>
                        </tr>
                    </tody>
                </table>

            </div>

        </div>
        <div id='rater'>
            <h2>Test Result</h2>
            <div>
                <table>
                    <tbody>
                        <tr>
                            <td>
                                <div></div>
                            </td>
                            <td>
                                <div>1</div>
                            </td>
                            <td>
                                <div>2</div>
                            </td>
                            <td>
                                <div>3</div>
                            </td>
                            <td>
                                <div>4</div>
                            </td>
                            <td>
                                <div>5</div>
                            </td>
                            <td>
                                <div>6</div>
                            </td>
                            <td>
                                <div>7</div>
                            </td>
                            <td>
                                <div>8</div>
                            </td>
                            <td>
                                <div>9</div>
                            </td>
                            <td>
                                <div>10</div>
                            </td>
                            <td>
                                <div>11</div>
                            </td>
                            <td>
                                <div>12</div>
                            </td>
                            <td>
                                <div>13</div>
                            </td>
                            <td>
                                <div>14</div>
                            </td>


                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>


</body>
<script>
    var current_position = 0;
    var answer = [];
    var hightlight_count = 0;
    var current_passage = 0;
    var current_split = [];
    var highlight_each = [0, 0, 0];
    var highlight_q = [];


    function render_page(position) {
        if ((position != -1) && (questions[position].type != 'structure')) {
            $('#rater').css('display', 'none');
            $('#majority').css('display', 'block');
            $('#structure').css('display', 'none');
            //插入文章部分
            //计算当前文章
            for (let i in current_split) {
                if (position >= current_split[i]) {
                    current_passage = i;
                }
            }
            //插入标题和文章
            $('#title').html(title[current_passage]);
            $('#content').html(passage[current_passage]);

            //清除高亮/段落标记/插入题标记/插入题事件
            $('#content').find('strong').css('display', 'none');
            $('#content').find('strong').off('click');
            $('#content').find('span').css('background-color', 'transparent');
            $('b').remove();

            //创建问题并加载答案
            $("#left").html(create_question(questions[position]));
            try {
                $("input:radio")[Number(answer[position])].setAttribute('checked', true);
            } catch (error) {;
            }
            //创建高亮/段落标记
            if (questions[position].type == 'highlight') {
                highlighter()
            }
            //绑定插入事件
            if (questions[position].type == 'insertion') {

                $('#content').find('strong').on('click', insertion_click);
                let stns = answer[position];
                if (stns != null) {
                    $('#content').find('strong')[stns].innerHTML = '【' + questions[position].sentence + '】';
                }
            }
            for (let i = 0; i < questions[position].anchor.length; i++) {
                highlight = document.createElement('b');
                highlight.innerHTML = '▶';
                $('#content').children('p')[questions[position].anchor[i]].prepend(highlight);
            }
            //跳转到段落定位位置
            $('#passage').scrollTop($('#content').children('p')[questions[position].anchor[0]].offsetTop - 80);

        } else if ((position != -1) && (questions[position].type == 'structure')) {
            //渲染结构页
            $('#rater').css('display', 'none');
            $('#majority').css('display', 'none');
            $('#structure').css('display', 'block');
            //清除结构题样式
            $('#answer-choices div').css('visibility', 'visible');
            $('#question-field').find('ul li:gt(0)').find('div').html('');
            //写入答案中结构题样式

            $('#question-field').find('ul li:gt(0)').find('div').each(function(idx, e) {
                if (answer[current_position][idx] != null) {
                    let content = $('#answer-choices div')[answer[current_position][idx]].innerHTML;
                    this.innerHTML = content;
                    var val = this.getAttribute('value');
                    $('#answer-choices').find('div')[Number(val)].style.visibility = 'hidden';

                }
            });

            //写入结构题选项
            $('#structure-leading strong').html(questions[current_position].question)
            $('#answer-choices').find('div').each(function(idx, element) {
                let answer_list = ['A', 'B', 'C', 'D', 'E', 'F'];
                this.innerHTML = answer_list[idx] + '. ' + questions[position].options[idx];
            });

        } else if (position == -1) {
            //渲染打分页
            $('#rater').css('display', 'block');
            $('#majority').css('display', 'none');
            $('#structure').css('display', 'none');
            $('#rater tbody tr:gt(0)').remove();
            var alpha_list = ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H'];
            var table = $('#rater tbody')[0];

            let num_passage = 0;
            for (let reference in question_answer) {


                reference = Number(reference)
                if ((reference == (current_split[num_passage] - 1)) && (reference != 0)) {


                    table.appendChild(ref_tr);
                    table.appendChild(tru_tr);

                }
                if (Number(reference) == current_split[num_passage]) {
                    num_passage++;
                    var tru_tr = document.createElement('tr');
                    var ref_tr = document.createElement('tr');

                    ref_tr.innerHTML = '<th><div>Passage ' + (num_passage) + '</div></th>';
                    tru_tr.innerHTML = '<th><div></div></th>';
                }
                let ref_td = document.createElement('td');
                let tru_td = document.createElement('td');
                if (questions[reference].type == 'structure') {
                    let ref_string = '<div>';
                    let tru_string = '<div>';
                    for (let a in question_answer[reference]) {
                        ref_string += alpha_list[question_answer[reference][a]];
                        tru_string += (alpha_list[answer[reference][a]] == null) ? '' : alpha_list[answer[reference][a]];
                    }
                    tru_string += '</div>';
                    ref_string += '</div>';
                    ref_td.innerHTML = ref_string;
                    tru_td.innerHTML = tru_string;
                    tru_td.style.color = 'green';
                    tru_td.style.opacity = 0.6;
                    for (let j in question_answer[reference]) {
                        if (answer[reference].length != question_answer[reference].length) {
                            tru_td.style.color = 'red';
                            break
                        }
                        if (question_answer[reference].includes(Number(answer[reference][j]))) {

                            continue;
                        } else {
                            tru_td.style.color = 'red';
                            break
                        }
                    }

                } else {

                    ref_td.innerHTML = '<div>' + alpha_list[question_answer[reference]] + '</div>';
                    tru_td.innerHTML = '<div>' + ((alpha_list[answer[reference]] == null) ? "" : alpha_list[answer[reference]]) + '</div>';
                    if (ref_td.innerHTML != tru_td.innerHTML) {
                        tru_td.style.color = 'red';
                        tru_td.style.opacity = 0.6;
                    } else {
                        tru_td.style.color = 'green';
                        tru_td.style.opacity = 0.6;
                    }
                }

                tru_td.onclick = function() {
                    current_position = reference;
                    render_page(current_position);
                    $('#toreport').css('visibility', 'visible');

                }
                ref_tr.appendChild(ref_td);
                tru_tr.appendChild(tru_td);

            }



        }
    }


    function previous_question() {
        if (current_position > 0) {
            if (current_position < questions.length) {
                //记录选择的答案
                if ((questions[current_position].type == 'multiple') || (questions[current_position].type == 'highlight')) {
                    answer[current_position] = $('input:radio:checked').val();
                }
                if (questions[current_position].type == 'highlight') {
                    hightlight_count--;
                }
                current_position--;
                render_page(current_position);

            } else if (current_position == questions.length) {
                current_position--;
                render_page(current_position);

            }
        }

    }

    function next_question() {
        if (current_position < questions.length - 1) {
            //记录选择的答案
            if ((questions[current_position].type == 'multiple') || (questions[current_position].type == 'highlight')) {
                answer[current_position] = $('input:radio:checked').val();
            }
            //跳转到下一题
            current_position++;

            if (questions[current_position].type == 'highlight') {
                hightlight_count++;
            }
            render_page(current_position)


        } else {
            current_position++;
            render_page(position = -1);

        }


    }

    function create_question(question_obj) {
        if ((question_obj.type == 'multiple') || (question_obj.type == 'highlight')) {
            content = "<p>" + question_obj.question + "</p>";
            content += " <ul id=\"options\">\
                    <li><input type=\"radio\" name=\"option\" value=0>A. <span id=\"A\">" + question_obj.options[0] + "</span></li>\
                    <li><input type=\"radio\" name=\"option\" value=1>B. <span id=\"B\">" + question_obj.options[1] + "</span></li>\
                    <li><input type=\"radio\" name=\"option\" value=2>C. <span id=\"C\">" + question_obj.options[2] + "</span></li>\
                    <li><input type=\"radio\" name=\"option\" value=3>D. <span id=\"D\">" + question_obj.options[3] + "</span></li>\
                </ul>"
        } else if (question_obj.type == "insertion") {
            content = "<p>" + question_obj.question + "</p>";
            $('#content').find('strong').css('display', 'inline');
        } else if (question_obj.type == "structure") {;
            content = '<span>O ye~</span>'
        } else {
            console.log('unknown question type');
        }



        return content
    }

    function highlighter() {
        $('#content').find('span')[highlight_q.indexOf(current_position) - highlight_each[current_passage]].style.backgroundColor = '#cbcbcb';
    }

    function insertion_click() {
        // 排他实现插入句子
        $("#content strong").html("【】")
        this.innerHTML = '【' + questions[current_position].sentence + '】';
        answer[current_position] = this.getAttribute('value');
    } {

        // main code
        // write passage 

        // $('#title').html(title[current_passage]);
        // $('#content').html(passage[current_passage]);
        $('#navcontent').html('TPO ' + params['tpo'] + ' Reading Exercise');
        let split = 0;
        let passage_count = 0;
        current_split.push(split);
        for (let i in questions) {
            if (questions[i].type == 'highlight') {
                highlight_q.push(Number(i));
                try {
                    highlight_each[passage_count + 1]++;
                } catch (e) {;
                }
            }

            if (questions[i].type == 'structure') {
                passage_count++;
                answer[i] = [null, null, null];
                split = Number(i);
                current_split.push(split + 1);

            }

        }
        render_page(0);

        $('#next_question').on('click', next_question);
        $('#previous_question').on('click', previous_question);
        $('#content').find('strong').on('click', insertion_click);
        $('#answer-choices').find('div').on('click', function(e) {
            $('#question-field').find('ul li:gt(0)').find('div').each(function(idx, element) {
                if (this.innerHTML == '') {
                    index = e.delegateTarget.getAttribute('value');

                    this.innerHTML = $('#answer-choices').find('div')[index].innerHTML;
                    this.setAttribute('value', index);
                    $('#answer-choices').find('div')[index].style.visibility = 'hidden';
                    answer[current_position][Number(this.getAttribute('index'))] = index;
                    return false;
                }

            })
        });

        $('#question-field li:gt(0)>div').on('click', function(e) {
            if (this.innerHTML != '') {
                val = this.getAttribute('value');
                $('#answer-choices').find('div')[Number(val)].style.visibility = 'visible';
                this.innerHTML = '';
                answer[current_position][Number(this.getAttribute('index'))] = null;

            };
        });

        $('#backtoindex').on('click', function() {
            if (window.confirm('返回首页将失去所有做题记录，确定要返回吗？')) {
                window.location.href = 'index.html';
            }
        })
        $('#toreport').on('click', function() {
            if ((questions[current_position].type == 'multiple') || (questions[current_position].type == 'highlight')) {
                answer[current_position] = $('input:radio:checked').val();
            }
            current_position = questions.length;
            render_page(-1);

            $('#toreport').css('visibility', 'hidden');
        })

    }
</script>

</html>